# Integration Guide — External Connections Needed

This document lists every external API, data source, and service that Annadata OS references but does not yet connect to. Each entry includes what it would replace, how to set it up, and its cost.

---

## Quick Status

| Integration | Service | Currently | Status | Priority |
|------------|---------|-----------|--------|----------|
| OpenWeather API | Mausam Chakra | Seeded RNG weather | ENV var exists, not wired | HIGH |
| Sentinel Hub | Mausam Chakra, SoilScan | No satellite data | ENV var exists, not wired | MEDIUM |
| Google Gemini API | Kisaan Sahayak, Harvest Shakti | Template responses | Not connected | MEDIUM |
| AgMarkNet live feed | MSP Mitra | Static CSV (2024-2025) | Partial — CSV loaded | LOW |
| India Meteorological Dept | Mausam Chakra | Simulated alerts | Not connected | LOW |
| NABARD/RBI credit data | Kisan Credit | Heuristic formula | Not connected | LOW |
| IoT hardware (ESP32/RPi) | Jal Shakti | Simulated sensors | Not connected | LOW |
| SMS/WhatsApp gateway | Kisaan Sahayak | No notifications | Not connected | LOW |

---

## 1. OpenWeather API

**Used by**: Mausam Chakra (port 8011)

**What it replaces**: All weather data in Mausam Chakra is currently generated by seeded RNG with seasonal patterns. Real API integration would provide actual current conditions, 7-day forecasts, and historical data.

**Setup**:
1. Sign up at https://openweathermap.org/api
2. Get a free API key (no credit card required)
3. Add to `.env`:
   ```
   OPENWEATHER_API_KEY=your_key_here
   ```

**Free tier limits**:
- 1,000 API calls/day (current weather, forecast)
- 5-day / 3-hour forecast
- No historical data on free tier (need "One Call API 3.0" — 1,000 calls/day free)

**Endpoints to use**:
```
# Current weather by lat/lon
GET https://api.openweathermap.org/data/2.5/weather?lat={lat}&lon={lon}&appid={key}&units=metric

# 5-day forecast
GET https://api.openweathermap.org/data/2.5/forecast?lat={lat}&lon={lon}&appid={key}&units=metric
```

**Where to wire in**: Replace the `_generate_current_weather()` and `_generate_forecast()` functions in `services/mausam_chakra/app.py` with HTTP calls to OpenWeather. Fall back to simulated data if the API key is missing or the call fails.

**Cost**: Free for development. $0 for up to 1,000 calls/day.

---

## 2. Sentinel Hub (Satellite Imagery)

**Used by**: Mausam Chakra (satellite fusion), SoilScan AI (photo analysis)

**What it replaces**: The `/satellite/fusion` endpoint currently generates fake satellite observations. Real integration would provide NDVI, soil moisture, and land surface temperature from Sentinel-2/Landsat.

**Setup**:
1. Register at https://www.sentinel-hub.com/
2. Create an OAuth client
3. Add to `.env`:
   ```
   SENTINEL_HUB_CLIENT_ID=your_client_id
   SENTINEL_HUB_CLIENT_SECRET=your_client_secret
   ```

**Free tier limits**:
- 30,000 processing units/month on the Exploration plan (free)
- Sufficient for ~300 NDVI tile requests/month at 10m resolution

**API to use**: Sentinel Hub Process API for on-the-fly NDVI computation:
```python
# Example: get NDVI for a bounding box
import requests

token = get_sentinel_token(client_id, client_secret)
response = requests.post(
    "https://services.sentinel-hub.com/api/v1/process",
    headers={"Authorization": f"Bearer {token}"},
    json={
        "input": {
            "bounds": {"bbox": [77.0, 28.5, 77.5, 29.0], "properties": {"crs": "http://www.opengis.net/def/crs/EPSG/0/4326"}},
            "data": [{"type": "sentinel-2-l2a", "dataFilter": {"timeRange": {"from": "2025-01-01", "to": "2025-02-01"}}}]
        },
        "evalscript": "// NDVI evalscript ..."
    }
)
```

**Cost**: Free Exploration plan. Paid plans start at EUR 75/month if you exceed limits.

---

## 3. Google Gemini API (LLM)

**Used by**: Kisaan Sahayak (LLM agent, chat), Harvest Shakti (chatbot)

**What it replaces**: Template-based responses labeled "simulated Gemini" in both services. Real integration would provide natural language farming advice in 7+ Indian languages.

**Setup**:
1. Get API key at https://aistudio.google.com/apikey
2. Add to `.env`:
   ```
   GEMINI_API_KEY=your_key_here
   ```

**Free tier limits** (Gemini 1.5 Flash):
- 15 requests per minute
- 1 million tokens per day
- 1,500 requests per day
- This is generous enough for a demo or low-traffic deployment

**Integration code**:
```python
import google.generativeai as genai

genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
model = genai.GenerativeModel("gemini-1.5-flash")

async def get_llm_response(prompt: str, language: str = "en") -> str:
    system = f"You are an expert agricultural advisor for Indian farmers. Respond in {language}."
    response = model.generate_content(f"{system}\n\n{prompt}")
    return response.text
```

**Where to wire in**:
- `services/kisaan_sahayak/app.py` — replace the `agent_llm()` function and the `chat()` template matching
- `services/harvest_shakti/app.py` — replace the `gemini_chat()` function

**Alternative (free, local)**: Run Ollama with Llama 3.1 8B locally:
```bash
ollama pull llama3.1
# Then call http://localhost:11434/api/generate from the service
```
Needs 8GB RAM. No API key, fully offline.

**Cost**: Free tier is sufficient for demo/development.

---

## 4. AgMarkNet Live Price Feed

**Used by**: MSP Mitra (port 8001)

**Current state**: MSP Mitra loads a static CSV with 1.1M records from 2024-2025. This works well for historical analysis and model training but doesn't have today's prices.

**Options for live data**:

| Source | Method | Freshness |
|--------|--------|-----------|
| AgMarkNet website scraping | Selenium/Playwright | Daily (new data published each evening) |
| data.gov.in API | REST API with API key | Weekly batches |
| eNAM API | Official API (requires registration) | Near real-time |

**Setup for data.gov.in**:
1. Register at https://data.gov.in/
2. Get API key
3. Add to `.env`:
   ```
   DATA_GOV_API_KEY=your_key_here
   ```

**Where to wire in**: Add a Celery periodic task in `services/msp_mitra/tasks.py` that fetches new price data daily and appends it to the loaded DataFrame.

**Cost**: Free.

---

## 5. SMS / WhatsApp Notifications

**Used by**: Kisaan Sahayak (advisory delivery), MSP Mitra (price alerts)

**Currently**: Price alerts are stored in-memory but never actually sent. The Kisaan Sahayak LLM agent generates "WhatsApp-style" messages that go nowhere.

**Options**:

| Provider | Channel | Free Tier |
|----------|---------|-----------|
| **Twilio** | SMS + WhatsApp | $15.50 trial credit (no card needed) |
| **MSG91** | SMS (India-focused) | 5,000 free SMS on signup |
| **WhatsApp Business API** | WhatsApp | Requires Facebook Business verification |
| **Telegram Bot** | Telegram | Completely free, unlimited |

**Easiest path**: Create a Telegram bot (free, no verification):
```python
import httpx

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

async def send_alert(chat_id: str, message: str):
    await httpx.AsyncClient().post(
        f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage",
        json={"chat_id": chat_id, "text": message, "parse_mode": "Markdown"}
    )
```

**Cost**: Free (Telegram). Others have trial credits.

---

## 6. IoT Hardware (Jal Shakti Sensors/Valves)

**Used by**: Jal Shakti (port 8004)

**Currently**: Sensor readings are seeded RNG. Valve control is an in-memory state toggle. The endpoints are designed to be IoT-ready but aren't connected to real hardware.

**Hardware needed**:
- ESP32 microcontroller (~Rs 400)
- Capacitive soil moisture sensor (~Rs 150)
- DHT22 temperature/humidity sensor (~Rs 250)
- 12V solenoid valve + relay module (~Rs 500)
- Solar panel + charge controller (optional, ~Rs 1,500)

**Communication**: The ESP32 would POST sensor readings to `POST /iot/station-data` (Mausam Chakra) or a new endpoint on Jal Shakti, and poll `GET /iot/valve-status/{plot_id}` to check if it should open/close the valve.

**Protocol options**: HTTP (simplest), MQTT via Redis Pub/Sub (more efficient), or WebSocket.

**Cost**: Rs 1,300-2,800 per sensor node. Software integration is straightforward — the API contracts already exist.

---

## 7. India Meteorological Department (IMD)

**Used by**: Mausam Chakra (weather alerts)

**Currently**: Alert thresholds exist in code but evaluate against generated weather data.

**IMD doesn't have a public API**, but options include:
- **mausam.imd.gov.in** — scrape district-level forecasts and warnings
- **IITM Pune ESSO** — research data access (requires institutional request)
- Use OpenWeather alerts as a proxy (included in One Call API)

**Priority**: LOW — OpenWeather covers most use cases.

---

## 8. PostgreSQL Migration (In-Memory to Persistent)

**Currently**: 9 of 11 services use Python dicts (`_analysis_store`, `_score_store`, `_plot_store`, etc.) that are lost on container restart. PostgreSQL is running and the schema has `users` and `service_logs` tables, but no service-specific tables.

**What needs to happen**:
1. Add SQLAlchemy models for each service's data (soil analyses, credit scores, seed registrations, etc.) in `services/shared/db/models.py`
2. Replace `_store[id] = data` with `session.add(Model(**data))` + `session.commit()`
3. Replace `_store.get(id)` with `session.query(Model).filter_by(id=id).first()`

**This is a significant refactor** but follows a straightforward pattern. Each service already imports `init_db` and `close_db` from the shared session module.

**Priority**: MEDIUM — needed for any deployment beyond demo, but not blocking for presentation.

---

## Environment Variables Summary

Add these to your `.env` as you integrate each service:

```env
# Already in .env.example (infrastructure)
POSTGRES_SERVER=postgres
POSTGRES_USER=annadata
POSTGRES_PASSWORD=annadata_dev_password
POSTGRES_DB=annadata
REDIS_HOST=redis
JWT_SECRET_KEY=change-this-jwt-secret-in-production

# External APIs (add as needed)
OPENWEATHER_API_KEY=           # Mausam Chakra — free, get from openweathermap.org
SENTINEL_HUB_CLIENT_ID=       # Satellite imagery — free Exploration plan
SENTINEL_HUB_CLIENT_SECRET=
GEMINI_API_KEY=                # LLM responses — free 1.5 Flash tier
DATA_GOV_API_KEY=              # AgMarkNet live data — free
TELEGRAM_BOT_TOKEN=            # Alert notifications — free

# Optional IoT
MQTT_BROKER_URL=               # If using MQTT for sensor communication
```

---

## Integration Priority Roadmap

| Phase | Integration | Services Affected | Effort | Cost |
|-------|------------|-------------------|--------|------|
| **Phase 1** | OpenWeather API | Mausam Chakra | 2-3 hours | Free |
| **Phase 1** | Gemini API | Kisaan Sahayak, Harvest Shakti | 2-3 hours | Free |
| **Phase 2** | Wire existing trained models | Mausam Chakra (weather), Harvest Shakti (yield) | 2-4 hours | Free |
| **Phase 2** | PostgreSQL migration | All 9 in-memory services | 1-2 days | Free |
| **Phase 3** | Sentinel Hub | Mausam Chakra, SoilScan | 4-6 hours | Free |
| **Phase 3** | AgMarkNet live feed | MSP Mitra | 3-4 hours | Free |
| **Phase 4** | Telegram notifications | MSP Mitra, Kisaan Sahayak | 2 hours | Free |
| **Phase 4** | IoT hardware | Jal Shakti | 1-2 days + hardware | Rs 1,300+ |
